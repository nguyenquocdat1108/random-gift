<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Chọn quà ngẫu nhiên 🎁</title>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  margin-top: 60px;
  background: #fafafa;
}
input {
  padding: 10px;
  font-size: 16px;
  width: 220px;
}
button {
  padding: 10px 20px;
  font-size: 18px;
  margin-top: 10px;
  background: #0078d4;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
button:hover {
  background: #005fa3;
}
#result {
  font-size: 22px;
  font-weight: bold;
  margin-top: 25px;
  color: #0077cc;
}
#loading {
  display: none;
  font-size: 18px;
  color: #999;
}
</style>
</head>
<body>
<h2>🎁 Chương trình chọn quà 20/10 trường TH Chu Van An 🎁</h2>
<p>Nhập họ và tên của bạn để nhận quà:</p>
<input id="nameInput" placeholder="Ví dụ: Nguyễn Kim A" />
<br>
<button onclick="pickGift()">Chọn quà</button>
<p id="loading">Đang chọn quà...</p>
<div id="result"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // ✅ Cấu hình Firebase của bạn
  const firebaseConfig = {
  apiKey: "AIzaSyCuPgeWQSGFB5QDEjwJO8MyLSWF4XrLr7c",
  authDomain: "random-gift-event.firebaseapp.com",
  databaseURL: "https://random-gift-event-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "random-gift-event",
  storageBucket: "random-gift-event.firebasestorage.app",
  messagingSenderId: "388826948849",
  appId: "1:388826948849:web:f0251d566af9af90af3550"
};

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  async function pickGift() {
    const nameInput = document.getElementById("nameInput");
    const name = nameInput.value.trim();
    const resultDiv = document.getElementById("result");
    const loading = document.getElementById("loading");

    if (!name) {
      alert("Vui lòng nhập họ và tên!");
      return;
    }

    resultDiv.textContent = "";
    loading.style.display = "block";

    try {
      const snapshot = await get(ref(db, "gifts"));
      const gifts = snapshot.val();

      const available = Object.keys(gifts).filter(k => gifts[k] > 0);
      if (available.length === 0) {
        resultDiv.textContent = "🎉 Tất cả quà đã được nhận hết!";
        loading.style.display = "none";
        return;
      }

      const randomGift = available[Math.floor(Math.random() * available.length)];
      const remaining = gifts[randomGift] - 1;

      // Cập nhật số lượng còn lại và lưu người nhận
      await set(ref(db, "gifts/" + randomGift), remaining);
      await push(ref(db, "winners"), {
        name,
        gift: randomGift,
        time: new Date().toISOString()
      });

      loading.style.display = "none";
      resultDiv.innerHTML = `🎉 Xin chúc mừng <b>${name}</b>!<br>Bạn nhận được: <b>${randomGift}</b> 🎁`;

      nameInput.value = "";
    } catch (err) {
      loading.style.display = "none";
      resultDiv.textContent = "⚠️ Lỗi kết nối tới máy chủ: " + err.message;
    }
  }

  window.pickGift = pickGift;
</script>
</body>
</html>
